# .circleci/config.yml
version: 2.1

jobs:
  build-test:
    macos:
      xcode: "16.4.0"            # CircleCI 제공 이미지 중 안정 버전 사용 (필요 시 변경)
    resource_class: macos.m1.medium.gen1
    shell: /bin/bash -leo pipefail
    environment:
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8
    steps:
      - checkout

      - run:
          name: Show Xcode & Swift versions
          command: |
            xcodebuild -version
            swift --version

      - run:
          name: Setup mise
          command: |
            brew install mise
            echo 'eval "$(mise activate bash)"' >> $BASH_ENV
            source $BASH_ENV
            mise --version

      - run:
          name: Install Tuist CLI
          command: |
            source $BASH_ENV
            mise install tuist@4.36.0
            mise doctor

      - run:
          name: Tuist install
          command: |
            source $BASH_ENV
            tuist install

      - run:
          name: Tuist build Firebase (FirebaseSPMShared)
          command: |
            source $BASH_ENV
            tuist build FirebaseSPMShared

      - run:
          name: Tuist build (monoree_dev)
          command: |
            source $BASH_ENV
            tuist build Monoree_dev
            tuist build AnimalQuizLab_dev

      - run:
          name: Tuist test (optional by env)
          command: |
            if [ "${TUIST_TEST_ON_OFF}" = "true" ]; then
              source $BASH_ENV
              tuist test
            else
              echo "TUIST_TEST_ON_OFF != true → skip tests"
            fi

workflows:
  ci:
    jobs:
      - build-test
